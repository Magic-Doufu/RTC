<!DOCTYPE html>
<html>
<head>
	<title>aoidji</title>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/barcodes/JsBarcode.code128.min.js"></script>
	<meta charset="utf-8">
</head>
<body>
    <style>
        /* In order to place the tracking correctly */
        canvas.drawing, canvas.drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
        }
        #scanner-container {
		  width: 100%;
		  height: auto;
		}
    </style>
    <div>
		<input type="text" id="barcode_in" value="E1230448">
	</div>
	<img id="barcode">
	<div id="output"></div>
    <div>
	<video id="scanner-container" autoplay="autoplay"></video>
	</div>
	<div class="d-flex">
		<button class="btn btn-primary flex-fill mr-2" id="cam_on">啟動相機</button>
		<button class="btn btn-primary flex-fill mx-2" id="torch_on">開燈</button>
		<button class="btn btn-primary flex-fill mx-2" id="torch_off">關燈</button>
		<button class="btn btn-primary flex-fill ml-2" id="cam_off">關閉相機</button>
		<button class="btn btn-outline-secondary" type="button" onclick="snap('O_serial')">scan</button>
	</div>
</body>
<script type="text/javascript">
	$('#barcode_in').on('keyup',function() {
		$("#barcode").JsBarcode(this.value, {
		  width:1,
		  height:23,
		  fontSize: 14
		});
	})
	window.addEventListener("orientationchange", function(){
    alert(window.orientation);
}, false);

window.cambarcode = class cambarcode {
  	constructor(tg) {
  	  this.target = document.getElementById(tg);
  	  this.osd = document.createElement('canvas');
  	  this.osd.style.cssText = 'position: absolute;left: 0;top: 0;height: 100%;width: 100%;';
  	  this.osd.id = tg + '-osd'
  	}

	init(callback){ //載入攝影機，後鏡頭。
		//篩選確定有攝影機
		navigator.mediaDevices.enumerateDevices().then(devices => {
			const cameras = devices.filter((device) => device.kind === 'videoinput');
    		if (cameras.length === 0) {
    			callback();
    			alert('No camera found on this device.');
    		  	throw 'No camera found on this device.';
    		}
    		// 選擇攝影機未做
    		// 確定有攝影機
			const w = { min: 1024, ideal: 1280, max: 1920 };
			const h = { min: 240, ideal: 400, max: 1080 };
			const constraints = {
  			video: {
        	  facingMode: 'environment',
  			  width: w,
  			  height: h,
  			  aspectRatio: 1.7777777778
  			},
        	audio: false
    		};
    		//偵測螢幕是寬還是高
			if(window.orientation == 0 && window.screen.height > window.screen.width) {
				constraints.video.height = w;
				constraints.video.width = h;
			}
			//開啟攝影機的串流
    		navigator.mediaDevices
        		.getUserMedia(constraints)
        		.then(stream => {
        		    this.target.srcObject = stream;
        		    this.target.style.display = 'block';
					this.target.parentElement.style.position = 'relative';
					var cv = this.osd;
					this.target.parentElement.append(cv);
					var ctx = cv.getContext("2d");
					ctx.rect(0, (cv.height / 2) - 1, cv.width, 2);
					ctx.strokeStyle="red";
					ctx.stroke();
        		})
        		.catch(error => {
        		    console.error(error);
        		})
        });
	}

	torch(state) {
		var track = this.target.srcObject.getVideoTracks()[0]
        track.applyConstraints({advanced: [{torch: state}]});
	}

	stop() {
		var cv = this.osd;
		const context = cv.getContext('2d');
		context.clearRect(0, 0, cv.width, cv.height);
	    this.target.srcObject.getTracks().forEach(function(track) {
	        if (track.readyState == 'live') {
	            track.stop();
	        }
	    });
	}

	getbc(callback) {
		const cap = new ImageCapture(this.target.srcObject.getVideoTracks()[0]);
		cap.grabFrame().then(frame => {
			var cv = document.createElement("canvas");
			var ctx = cv.getContext("2d");
			cv.width = frame.width * 0.6
			cv.height = 40
			ctx.drawImage(frame, frame.width * 0.2, (frame.height / 2) - 20, cv.width, 40, 0, 0, cv.width, 40);
	    	const bcd = new BarcodeDetector();
	    	bcd.detect(cv)
	    	    .then(barcodes => {if(barcodes.length) {callback(barcodes[0].rawValue)}})
	    	    .catch((e) => {
	    	        alert("Barcode detection fail!" + e);
	    	    })
		})
	}
}
</script>
<script type="text/javascript">
	var cam = new cambarcode('scanner-container')
	$('#cam_on').click(function(){cam.init()})
	$('#cam_off').click(function(){cam.stop()})
	$('#torch_on').click(function(){cam.torch(true)})
	$('#torch_off').click(function(){cam.torch(false)})
	function snap(id) {
		//document.getElementById(id).value
		cam.getbc(rawval => {alert(rawval)});
		return false;
	}
</script>
</html>